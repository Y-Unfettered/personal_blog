<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>本地后台 - DevLog</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/md-editor-v3@2.11.3/lib/style.css" />
    <style>
      .hide-scrollbar::-webkit-scrollbar { display: none; }
      .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }
      .chip {
        display: inline-flex;
        align-items: center;
        border-radius: 9999px;
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        border: 1px solid #1f2937;
        background: #111827;
        color: #cbd5f5;
        transition: all 0.2s ease;
      }
      .chip:hover { border-color: rgba(99, 102, 241, 0.5); color: #ffffff; }
      .chip-active { background: rgba(99, 102, 241, 0.18); border-color: rgba(99, 102, 241, 0.6); color: #e0e7ff; }
      .nav-row { cursor: grab; }
      .nav-row.nav-row-dragging { opacity: 0.4; cursor: grabbing; }
      .nav-row.nav-row-over { outline: 1px dashed rgba(99, 102, 241, 0.5); background: rgba(99, 102, 241, 0.08); }
    </style>
  </head>
  <body class="bg-[#0f1115] text-gray-200 font-sans selection:bg-indigo-500/30">
    <nav class="sticky top-0 z-50 bg-[#0f1115]/80 backdrop-blur-xl border-b border-gray-800">
      <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center">
            <span class="iconify text-white text-xl" data-icon="lucide:terminal"></span>
          </div>
          <span class="text-xl font-bold tracking-tight text-white">DevLog<span class="text-indigo-500">_</span></span>
        </div>
        <div class="hidden md:flex items-center space-x-6 text-sm font-medium text-gray-400">
          <button class="hover:text-white" onclick="setTab('posts')">文章管理</button>
          <button class="hover:text-white" onclick="setTab('issues')">问题管理</button>
          <button class="hover:text-white" onclick="setTab('tools')">工具管理</button>
          <button class="hover:text-white" onclick="setTab('categories')">分类管理</button>
          <button class="hover:text-white" onclick="setTab('tags')">标签管理</button>
          <button class="hover:text-white" onclick="setTab('nav')">导航管理</button>
          <button class="hover:text-white" onclick="setTab('profile')">个人介绍</button>
          <button class="hover:text-white" onclick="setTab('publish')">发布管理</button>
          <button class="hover:text-white" onclick="setTab('settings')">主题设置</button>
        </div>
      </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-8 min-h-[calc(100vh-144px)]">
      <div id="status" class="hidden"></div>

      <section id="tab-posts" class="animate-slide-up">
        <div class="flex items-center justify-between mb-6">
          <h1 class="text-2xl font-bold text-white">文章管理</h1>
          <div class="flex items-center space-x-3">
            <input
              id="post-search"
              class="bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5 text-sm w-64 focus:border-indigo-500 outline-none"
              placeholder="搜索标题 / 摘要 / 分类 / 标签"
            />
            <div class="hidden md:flex items-center space-x-2 px-3 py-2 rounded-lg bg-gray-900 border border-gray-800 text-xs text-gray-400">
              <span id="pinned-count">置顶 0/3</span>
              <label class="flex items-center space-x-2">
                <input id="auto-unpin" type="checkbox" class="w-4 h-4 rounded bg-gray-900 border-gray-800 text-indigo-600" checked />
                <span>超限自动取消最旧置顶</span>
              </label>
            </div>
            <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm" onclick="openPostEditor()">新增文章</button>
          </div>
        </div>
        <div class="bg-[#161b22] border border-gray-800 rounded-xl overflow-hidden">
          <table class="w-full text-left text-sm">
            <thead class="bg-gray-900/50 text-gray-400 uppercase text-xs tracking-wider">
              <tr>
                <th class="px-6 py-4 font-semibold">标题</th>
                <th class="px-6 py-4 font-semibold">栏目</th>
                <th class="px-6 py-4 font-semibold">分类</th>
                <th class="px-6 py-4 font-semibold">状态</th>
                <th class="px-6 py-4 font-semibold">日期</th>
                <th class="px-6 py-4 font-semibold text-right">操作</th>
              </tr>
            </thead>
            <tbody id="posts-body" class="divide-y divide-gray-800"></tbody>
          </table>
        </div>
        <div class="flex items-center justify-between mt-4">
          <div id="post-page-info" class="text-xs text-gray-500"></div>
          <div class="flex items-center space-x-2">
            <button id="post-prev" class="px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700 disabled:opacity-40" onclick="prevPage()">上一页</button>
            <div id="post-page-buttons" class="flex items-center space-x-2"></div>
            <button id="post-next" class="px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700 disabled:opacity-40" onclick="nextPage()">下一页</button>
            <div class="flex items-center space-x-2 ml-2">
              <input id="post-page-jump" class="w-16 bg-gray-900 border border-gray-800 rounded-md px-2 py-1 text-xs text-gray-200" placeholder="页数" />
              <button class="px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700" onclick="jumpPage()">跳转</button>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-categories" class="hidden animate-slide-up">
        <div class="flex items-center justify-between mb-6">
          <h1 class="text-2xl font-bold text-white">分类管理</h1>
          <div class="flex items-center space-x-3">
            <input
              id="category-search"
              class="bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5 text-sm w-64 focus:border-indigo-500 outline-none"
              placeholder="搜索分类名称 / Slug"
            />
            <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm" onclick="openCategoryEditor()">新增分类</button>
          </div>
        </div>
        <div class="bg-[#161b22] border border-gray-800 rounded-xl overflow-hidden">
          <table class="w-full text-left text-sm">
              <thead class="bg-gray-900/50 text-gray-400 uppercase text-xs tracking-wider">
                <tr>
                  <th class="px-6 py-4 font-semibold">名称</th>
                  <th class="px-6 py-4 font-semibold">Slug</th>
                  <th class="px-6 py-4 font-semibold">栏目</th>
                  <th class="px-6 py-4 font-semibold text-right">操作</th>
                </tr>
              </thead>
            <tbody id="categories-body" class="divide-y divide-gray-800"></tbody>
          </table>
        </div>
        <div class="flex items-center justify-between mt-4">
          <div id="categories-page-info" class="text-xs text-gray-500"></div>
          <div class="flex items-center space-x-2">
            <button id="categories-prev" class="px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700 disabled:opacity-40" onclick="prevCategoryPage()">上一页</button>
            <div id="categories-page-buttons" class="flex items-center space-x-2"></div>
            <button id="categories-next" class="px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700 disabled:opacity-40" onclick="nextCategoryPage()">下一页</button>
            <div class="flex items-center space-x-2 ml-2">
              <input id="categories-page-jump" class="w-16 bg-gray-900 border border-gray-800 rounded-md px-2 py-1 text-xs text-gray-200" placeholder="页数" />
              <button class="px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700" onclick="jumpCategoryPage()">跳转</button>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-tags" class="hidden animate-slide-up">
        <div class="flex items-center justify-between mb-6">
          <h1 class="text-2xl font-bold text-white">标签管理</h1>
          <div class="flex items-center space-x-3">
            <input
              id="tag-search"
              class="bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5 text-sm w-64 focus:border-indigo-500 outline-none"
              placeholder="搜索标签名称 / Slug"
            />
            <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm" onclick="openTagEditor()">新增标签</button>
          </div>
        </div>
        <div class="bg-[#161b22] border border-gray-800 rounded-xl overflow-hidden">
          <table class="w-full text-left text-sm">
            <thead class="bg-gray-900/50 text-gray-400 uppercase text-xs tracking-wider">
              <tr>
                <th class="px-6 py-4 font-semibold">名称</th>
                <th class="px-6 py-4 font-semibold">Slug</th>
                <th class="px-6 py-4 font-semibold text-right">操作</th>
              </tr>
            </thead>
            <tbody id="tags-body" class="divide-y divide-gray-800"></tbody>
          </table>
        </div>
        <div class="flex items-center justify-between mt-4">
          <div id="tags-page-info" class="text-xs text-gray-500"></div>
          <div class="flex items-center space-x-2">
            <button id="tags-prev" class="px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700 disabled:opacity-40" onclick="prevTagPage()">上一页</button>
            <div id="tags-page-buttons" class="flex items-center space-x-2"></div>
            <button id="tags-next" class="px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700 disabled:opacity-40" onclick="nextTagPage()">下一页</button>
            <div class="flex items-center space-x-2 ml-2">
              <input id="tags-page-jump" class="w-16 bg-gray-900 border border-gray-800 rounded-md px-2 py-1 text-xs text-gray-200" placeholder="页数" />
              <button class="px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700" onclick="jumpTagPage()">跳转</button>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-nav" class="hidden animate-slide-up">
        <div class="flex items-center justify-between mb-6">
          <h1 class="text-2xl font-bold text-white">导航管理</h1>
          <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm" onclick="openNavEditor()">新增导航</button>
        </div>
        <div class="bg-[#161b22] border border-gray-800 rounded-xl overflow-hidden">
          <table class="w-full text-left text-sm">
            <thead class="bg-gray-900/50 text-gray-400 uppercase text-xs tracking-wider">
              <tr>
                <th class="px-6 py-4 font-semibold">名称</th>
                <th class="px-6 py-4 font-semibold">链接</th>
                <th class="px-6 py-4 font-semibold">顺序</th>
                <th class="px-6 py-4 font-semibold">显示</th>
                <th class="px-6 py-4 font-semibold text-right">操作</th>
              </tr>
            </thead>
            <tbody id="nav-body" class="divide-y divide-gray-800"></tbody>
          </table>
        </div>
        <div class="flex items-center justify-between mt-4">
          <div id="nav-page-info" class="text-xs text-gray-500"></div>
          <div class="flex items-center space-x-2">
            <button id="nav-prev" class="px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700 disabled:opacity-40" onclick="prevNavPage()">上一页</button>
            <div id="nav-page-buttons" class="flex items-center space-x-2"></div>
            <button id="nav-next" class="px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700 disabled:opacity-40" onclick="nextNavPage()">下一页</button>
            <div class="flex items-center space-x-2 ml-2">
              <input id="nav-page-jump" class="w-16 bg-gray-900 border border-gray-800 rounded-md px-2 py-1 text-xs text-gray-200" placeholder="页数" />
              <button class="px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700" onclick="jumpNavPage()">跳转</button>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-profile" class="hidden animate-slide-up">
        <h1 class="text-2xl font-bold text-white mb-6">个人介绍</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-[#161b22] border border-gray-800 rounded-xl p-6 space-y-4">
            <h2 class="text-sm font-semibold text-gray-400 uppercase">首页个人信息</h2>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">昵称</label>
              <input id="profile-name" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" placeholder="Lemon" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">副标题</label>
              <input id="profile-subtitle" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" placeholder="记录灵感 · 设计 · 代码" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">座右铭</label>
              <textarea id="profile-motto" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" placeholder="以持续输出为信仰..."></textarea>
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">头像 URL</label>
              <input id="profile-avatar" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" placeholder="https://..." />
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">GitHub 主页</label>
              <input id="profile-github" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" placeholder="https://github.com/username" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">知识星球链接</label>
              <input id="profile-planet" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" placeholder="https://wx.zsxq.com/..." />
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">邮箱</label>
              <input id="profile-email" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" placeholder="name@example.com" />
            </div>
          </div>
          <div class="bg-[#161b22] border border-gray-800 rounded-xl p-6 space-y-4">
            <h2 class="text-sm font-semibold text-gray-400 uppercase">关于我内容</h2>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">关于标题</label>
              <input id="about-title" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" placeholder="关于这个博客" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">关于正文</label>
              <textarea id="about-content" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" rows="4"></textarea>
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">技能标题</label>
              <input id="skills-title" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" placeholder="核心技能栈" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">技能列表 (JSON 数组)</label>
              <textarea id="skills-json" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5 font-mono text-xs" rows="6" placeholder='[{ "label": "TypeScript", "icon": "logos:typescript-icon", "color": "#34d399" }]'></textarea>
            </div>
          </div>
        </div>
        <div class="flex justify-end mt-6">
          <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg text-sm" onclick="saveProfileSettings()">保存个人介绍</button>
        </div>
      </section>

      <section id="tab-publish" class="hidden animate-slide-up">
        <h1 class="text-2xl font-bold text-white mb-6">发布管理</h1>
        <div class="bg-[#161b22] border border-gray-800 rounded-xl p-6 space-y-4">
          <button class="bg-gray-800 hover:bg-gray-700 text-gray-200 px-4 py-2 rounded-lg text-sm" onclick="generateJson()">仅生成 JSON</button>
          <div class="flex items-center space-x-3">
            <input id="publish-title" class="flex-1 bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5 focus:border-indigo-500 outline-none" placeholder="提交标题（用于 git commit）" />
            <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm" onclick="publish()">发布并推送</button>
          </div>
        </div>
      </section>

      <section id="tab-issues" class="hidden animate-slide-up">
        <div class="flex items-center justify-between mb-6">
          <h1 class="text-2xl font-bold text-white">管理问题</h1>
          <div class="flex items-center space-x-3">
            <input
              id="issue-search"
              class="bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5 text-sm w-64 focus:border-indigo-500 outline-none"
              placeholder="搜索问题标题 / 描述"
            />
            <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm" onclick="openIssueEditor()">新增问题</button>
          </div>
        </div>
        <div class="bg-[#161b22] border border-gray-800 rounded-xl overflow-hidden">
          <table class="w-full text-left text-sm">
            <thead class="bg-gray-900/50 text-gray-400 uppercase text-xs tracking-wider">
              <tr>
                <th class="px-6 py-4 font-semibold">标题</th>
                <th class="px-6 py-4 font-semibold">优先级</th>
                <th class="px-6 py-4 font-semibold">状态</th>
                <th class="px-6 py-4 font-semibold">日期</th>
                <th class="px-6 py-4 font-semibold text-right">操作</th>
              </tr>
            </thead>
            <tbody id="issues-body" class="divide-y divide-gray-800"></tbody>
          </table>
        </div>
        <div class="flex items-center justify-between mt-4">
          <div id="issues-page-info" class="text-xs text-gray-500"></div>
          <div class="flex items-center space-x-2">
            <button id="issues-prev" class="px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700 disabled:opacity-40" onclick="prevIssuePage()">上一页</button>
            <div id="issues-page-buttons" class="flex items-center space-x-2"></div>
            <button id="issues-next" class="px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700 disabled:opacity-40" onclick="nextIssuePage()">下一页</button>
            <div class="flex items-center space-x-2 ml-2">
              <input id="issues-page-jump" class="w-16 bg-gray-900 border border-gray-800 rounded-md px-2 py-1 text-xs text-gray-200" placeholder="页数" />
              <button class="px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700" onclick="jumpIssuePage()">跳转</button>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-tools" class="hidden animate-slide-up">
        <div class="flex items-center justify-between mb-6">
          <h1 class="text-2xl font-bold text-white">工具管理</h1>
          <div class="flex items-center space-x-3">
            <input
              id="tool-search"
              class="bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5 text-sm w-64 focus:border-indigo-500 outline-none"
              placeholder="搜索工具名称 / 描述"
            />
            <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm" onclick="openToolEditor()">新增工具</button>
          </div>
        </div>
        <div class="bg-[#161b22] border border-gray-800 rounded-xl overflow-hidden">
          <table class="w-full text-left text-sm">
            <thead class="bg-gray-900/50 text-gray-400 uppercase text-xs tracking-wider">
              <tr>
                <th class="px-6 py-4 font-semibold">名称</th>
                <th class="px-6 py-4 font-semibold">类型</th>
                <th class="px-6 py-4 font-semibold">更新日期</th>
                <th class="px-6 py-4 font-semibold">来源</th>
                <th class="px-6 py-4 font-semibold text-right">操作</th>
              </tr>
            </thead>
            <tbody id="tools-body" class="divide-y divide-gray-800"></tbody>
          </table>
        </div>
        <div class="flex items-center justify-between mt-4">
          <div id="tools-page-info" class="text-xs text-gray-500"></div>
          <div class="flex items-center space-x-2">
            <button id="tools-prev" class="px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700 disabled:opacity-40" onclick="prevToolPage()">上一页</button>
            <div id="tools-page-buttons" class="flex items-center space-x-2"></div>
            <button id="tools-next" class="px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700 disabled:opacity-40" onclick="nextToolPage()">下一页</button>
            <div class="flex items-center space-x-2 ml-2">
              <input id="tools-page-jump" class="w-16 bg-gray-900 border border-gray-800 rounded-md px-2 py-1 text-xs text-gray-200" placeholder="页数" />
              <button class="px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700" onclick="jumpToolPage()">跳转</button>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-settings" class="hidden animate-slide-up">
        <h1 class="text-2xl font-bold text-white mb-6">主题设置</h1>
        <div class="bg-[#161b22] border border-gray-800 rounded-xl p-6 space-y-6">
          <div>
            <h2 class="text-sm font-semibold text-gray-400 mb-3 uppercase">Markdown 主题</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <label class="flex items-center space-x-3 p-4 bg-gray-900 border border-gray-800 rounded-lg cursor-pointer">
                <input type="radio" name="md-theme" value="default" class="text-indigo-600" />
                <div>
                  <div class="text-sm font-semibold text-white">Default</div>
                  <div class="text-xs text-gray-500">md-editor 默认主题</div>
                </div>
              </label>
              <label class="flex items-center space-x-3 p-4 bg-gray-900 border border-gray-800 rounded-lg cursor-pointer">
                <input type="radio" name="md-theme" value="mk-cute" class="text-indigo-600" />
                <div>
                  <div class="text-sm font-semibold text-white">Mk Cute</div>
                  <div class="text-xs text-gray-500">更活泼的标题和引用样式</div>
                </div>
              </label>
              <label class="flex items-center space-x-3 p-4 bg-gray-900 border border-gray-800 rounded-lg cursor-pointer">
                <input type="radio" name="md-theme" value="smart-blue" class="text-indigo-600" />
                <div>
                  <div class="text-sm font-semibold text-white">Smart Blue</div>
                  <div class="text-xs text-gray-500">更清晰的层级结构</div>
                </div>
              </label>
              <label class="flex items-center space-x-3 p-4 bg-gray-900 border border-gray-800 rounded-lg cursor-pointer">
                <input type="radio" name="md-theme" value="cyanosis" class="text-indigo-600" />
                <div>
                  <div class="text-sm font-semibold text-white">Cyanosis</div>
                  <div class="text-xs text-gray-500">浅色高对比风格</div>
                </div>
              </label>
            </div>
          </div>
          <div class="flex justify-end">
            <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg text-sm" onclick="saveSettings()">保存设置</button>
          </div>
        </div>
      </section>
    </main>

    <div id="editor" class="fixed inset-0 z-50 bg-[#0f1115]/95 backdrop-blur-sm hidden items-center justify-center p-4">
      <div class="bg-[#161b22] border border-gray-800 w-full max-w-4xl rounded-xl shadow-2xl flex flex-col max-h-[90vh]">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center">
          <h2 id="editor-title" class="text-lg font-bold">编辑</h2>
          <button class="text-gray-500 hover:text-white" onclick="closeEditor()"><span class="iconify text-2xl" data-icon="lucide:x"></span></button>
        </div>
        <div class="p-6 overflow-y-auto hide-scrollbar flex-1" id="editor-body"></div>
        <div class="p-4 border-t border-gray-800 flex items-center justify-between">
          <button class="px-6 py-2 text-gray-400 hover:text-white text-sm font-medium" onclick="closeEditor()">取消</button>
          <div class="flex items-center space-x-3">
            <button id="editor-save" class="bg-indigo-600 px-6 py-2 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 transition-colors">保存</button>
            <button id="editor-publish" class="bg-emerald-600 px-6 py-2 text-white rounded-lg text-sm font-bold hover:bg-emerald-700 transition-colors hidden">发布</button>
          </div>
        </div>
      </div>
    </div>

    <div id="toast" class="fixed left-1/2 top-6 -translate-x-1/2 z-50 hidden">
      <div id="toast-body" class="px-4 py-3 rounded-lg text-sm border border-gray-800 bg-[#161b22] text-gray-200 shadow-xl"></div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/md-editor-v3@2.11.3/lib/md-editor-v3.umd.js"></script>
    <script>
      let posts = [];
      let categories = [];
      let tags = [];
      let navItems = [];
      let issues = [];
      let tools = [];
      let categoryNameMap = {};
      let tagNameMap = {};
      let currentPage = 1;
      const pageSize = 10;
      let searchQuery = '';
      let currentCategoryPage = 1;
      let currentTagPage = 1;
      let currentNavPage = 1;
      let currentIssuePage = 1;
      let currentToolPage = 1;
      let categorySearchQuery = '';
      let tagSearchQuery = '';
      let issueSearchQuery = '';
      let toolSearchQuery = '';
      let autoUnpinOnLimit = true;
      let mdEditorApp = null;
      let mdEditorRoot = null;
      let mdEditorContent = '';
      let mdEditorAutosaveTimer = null;
      let mdEditorFullscreenEnabled = false;
      let settings = { markdownTheme: 'default' };

      function setStatus(text, isError) {
        if (!text) return;
        showToast(text, !!isError);
      }

      function showToast(message, isError) {
        const toast = document.getElementById('toast');
        const body = document.getElementById('toast-body');
        body.textContent = message;
        body.className = isError
          ? 'px-4 py-3 rounded-lg text-sm border border-red-500/40 bg-[#1a0f12] text-red-200 shadow-xl'
          : 'px-4 py-3 rounded-lg text-sm border border-emerald-500/30 bg-[#0f1a14] text-emerald-200 shadow-xl';
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), isError ? 1000 : 2000);
      }

      function statusLabel(status) {
        return status === 'published' ? '已发布' : '草稿';
      }

      function todayISO() {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
      }

      function simpleSlugify(value) {
        const columnMap = {
          '设计创作': 'design',
          '工具分享': 'tools',
          '问题记录': 'issues',
          '生活随笔': 'life',
          '技术笔记': 'technology'
        };
        
        const str = String(value || '').trim();
        
        // 检查是否有预设的英文对应值
        if (columnMap[str]) {
          return columnMap[str];
        }
        
        // 对于其他值，使用默认的slugify逻辑
        return str
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '');
      }

      function categorySlugFromId(categoryId) {
        if (!categoryId) return '';
        const cat = categories.find((c) => c.id === categoryId);
        if (!cat) return '';
        if (cat.slug) return String(cat.slug).trim();
        if (cat.name) return simpleSlugify(cat.name);
        return simpleSlugify(categoryId);
      }

      function categoryPostIndex(categoryId, currentId) {
        if (!categoryId) return 1;
        const list = posts
          .filter((p) => Array.isArray(p.categories) && p.categories.includes(categoryId))
          .slice()
          .sort((a, b) => {
            const ad = a.created_at || '';
            const bd = b.created_at || '';
            return ad.localeCompare(bd);
          });
        if (currentId) {
          const existingIndex = list.findIndex((p) => p.id === currentId);
          if (existingIndex >= 0) return existingIndex + 1;
        }
        return list.length + 1;
      }

      function buildColumnSlug(columnLabel, currentId) {
        if (!columnLabel) return '';
        const base = simpleSlugify(columnLabel) || columnLabel.toLowerCase().replace(/\s+/g, '-');
        if (!base) return '';
        const index = columnPostIndex(columnLabel, currentId);
        return `${base}?id=${index}`;
      }

      function columnPostIndex(columnLabel, currentId) {
        if (!columnLabel) return 1;
        const list = posts
          .filter((p) => {
            // 查找与栏目标签匹配的分类
            const catIds = Array.isArray(p.categories) ? p.categories : [];
            return catIds.some(id => categoryNameMap[id] === columnLabel);
          })
          .slice()
          .sort((a, b) => {
            const ad = a.created_at || '';
            const bd = b.created_at || '';
            return ad.localeCompare(bd);
          });
        if (currentId) {
          const existingIndex = list.findIndex((p) => p.id === currentId);
          if (existingIndex >= 0) return existingIndex + 1;
        }
        return list.length + 1;
      }

      function setTab(name) {
        ['posts', 'issues', 'tools', 'categories', 'tags', 'nav', 'profile', 'publish', 'settings'].forEach((tab) => {
          const el = document.getElementById(`tab-${tab}`);
          if (el) {
            el.classList.toggle('hidden', tab !== name);
          }
        });
      }

      async function api(path, options = {}) {
        const res = await fetch(path, {
          headers: { 'Content-Type': 'application/json' },
          ...options,
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || '请求失败');
        }
        return res.json().catch(() => ({}));
      }

      function getFilteredPosts() {
        const query = searchQuery.trim().toLowerCase();
        if (!query) return posts.slice();
        return posts.filter((p) => {
          const title = String(p.title || '').toLowerCase();
          const summary = String(p.summary || '').toLowerCase();
          const categoryIds = Array.isArray(p.categories) ? p.categories : [];
          const tagIds = Array.isArray(p.tags) ? p.tags : [];
          const categoryNames = categoryIds.map((id) => String(categoryNameMap[id] || '')).join(' ');
          const tagNames = tagIds.map((id) => String(tagNameMap[id] || '')).join(' ');
          const categoriesText = categoryIds.join(' ') + ' ' + categoryNames;
          const tagsText = tagIds.join(' ') + ' ' + tagNames;
          return (
            title.includes(query) ||
            summary.includes(query) ||
            categoriesText.toLowerCase().includes(query) ||
            tagsText.toLowerCase().includes(query)
          );
        });
      }

      function getColumnNavItems() {
        if (!Array.isArray(navItems) || navItems.length === 0) return [];
        return navItems
          .filter((item) => {
            if (!item || !item.label) return false;
            if (item.visible === false) return false;
            const href = String(item.href || '').trim().toLowerCase();
            if (!href) return true;
            if (href === '/' || href === '#/' || href === '#') return false;
            if (href.includes('about')) return false;
            return true;
          })
          .slice()
          .sort((a, b) => (Number(a.order || 0) || 0) - (Number(b.order || 0) || 0));
      }

      function getColumnLabels() {
        return getColumnNavItems()
          .map((item) => String(item.label || '').trim())
          .filter(Boolean);
      }

      function renderPageButtons(containerId, current, totalPages, goTo) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';
        if (totalPages <= 1) return;

        const maxButtons = 7;
        let start = Math.max(1, current - Math.floor(maxButtons / 2));
        let end = Math.min(totalPages, start + maxButtons - 1);
        if (end - start + 1 < maxButtons) {
          start = Math.max(1, end - maxButtons + 1);
        }

        if (start > 1) {
          const firstBtn = document.createElement('button');
          firstBtn.className = 'px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700';
          firstBtn.textContent = '1';
          firstBtn.onclick = () => goTo(1);
          container.appendChild(firstBtn);
          if (start > 2) {
            const dots = document.createElement('span');
            dots.className = 'text-xs text-gray-500';
            dots.textContent = '...';
            container.appendChild(dots);
          }
        }

        for (let i = start; i <= end; i += 1) {
          const btn = document.createElement('button');
          btn.className = i === current
            ? 'px-3 py-1.5 text-xs rounded-md bg-indigo-600 text-white'
            : 'px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700';
          btn.textContent = String(i);
          btn.onclick = () => goTo(i);
          container.appendChild(btn);
        }

        if (end < totalPages) {
          if (end < totalPages - 1) {
            const dots = document.createElement('span');
            dots.className = 'text-xs text-gray-500';
            dots.textContent = '...';
            container.appendChild(dots);
          }
          const lastBtn = document.createElement('button');
          lastBtn.className = 'px-3 py-1.5 text-xs rounded-md bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700';
          lastBtn.textContent = String(totalPages);
          lastBtn.onclick = () => goTo(totalPages);
          container.appendChild(lastBtn);
        }
      }

      function renderPosts() {
        const filtered = getFilteredPosts().slice().sort((a, b) => {
          const ap = a.pinned ? 1 : 0;
          const bp = b.pinned ? 1 : 0;
          if (ap !== bp) return bp - ap;
          const ad = a.created_at || a.updated_at || '';
          const bd = b.created_at || b.updated_at || '';
          return bd.localeCompare(ad);
        });
        const total = filtered.length;
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        const start = (currentPage - 1) * pageSize;
        const pageItems = filtered.slice(start, start + pageSize);
        const body = document.getElementById('posts-body');
        const resolveColumnLabel = (post) => {
          const ids = Array.isArray(post?.categories) ? post.categories : [];
          if (!ids.length) return '-';
          // 查找第一个分类的parent属性作为栏目
          for (const id of ids) {
            const category = categories.find(c => c.id === id);
            if (category && category.parent) {
              return category.parent;
            }
          }
          // 如果没有找到parent属性，返回第一个分类的名称
          const names = ids.map((id) => categoryNameMap[id] || id).filter(Boolean);
          if (!names.length) return ids[0] || '-';
          return names[0];
        };
        body.innerHTML = pageItems.map((p) => {
          const categoryNames = (p.categories || []).map(id => categoryNameMap[id] || id).filter(Boolean).join(', ');
          return `
          <tr class="hover:bg-gray-800/30 transition-colors">
            <td class="px-6 py-4 text-gray-200 font-medium">
              ${p.title}
              ${p.pinned ? '<span class="ml-2 px-2 py-0.5 text-xs rounded-full border border-indigo-500/40 text-indigo-300 bg-indigo-500/10">置顶</span>' : ''}
            </td>
            <td class="px-6 py-4 text-gray-400">${resolveColumnLabel(p)}</td>
            <td class="px-6 py-4 text-gray-500">${categoryNames || '-'}</td>
            <td class="px-6 py-4">${statusLabel(p.status)}</td>
            <td class="px-6 py-4 text-gray-500">${p.created_at || p.updated_at || ''}</td>
            <td class="px-6 py-4 text-right space-x-3">
              <button class="text-gray-400 hover:text-indigo-400" onclick="openPostEditor('${p.id}')"><span class="iconify" data-icon="lucide:edit-3"></span></button>
              <button class="text-gray-400 hover:text-red-400" onclick="deletePost('${p.id}')"><span class="iconify" data-icon="lucide:trash-2"></span></button>
            </td>
          </tr>
        `;
        }).join('');

        const info = document.getElementById('post-page-info');
        if (info) {
          info.textContent = total === 0 ? '暂无数据' : `第 ${currentPage} / ${totalPages} 页，共 ${total} 篇`;
        }
        const prevBtn = document.getElementById('post-prev');
        const nextBtn = document.getElementById('post-next');
        if (prevBtn) prevBtn.disabled = currentPage <= 1;
        if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
        renderPageButtons('post-page-buttons', currentPage, totalPages, goToPage);

        const pinnedCount = posts.filter((p) => p.pinned).length;
        const pinnedEl = document.getElementById('pinned-count');
        if (pinnedEl) pinnedEl.textContent = `置顶 ${pinnedCount}/3`;
      }

      function prevPage() {
        if (currentPage > 1) {
          currentPage -= 1;
          renderPosts();
        }
      }

      function nextPage() {
        currentPage += 1;
        renderPosts();
      }

      function goToPage(page) {
        const target = Number(page);
        if (!Number.isFinite(target)) return;
        currentPage = Math.max(1, target);
        renderPosts();
      }

      function jumpPage() {
        const input = document.getElementById('post-page-jump');
        if (!input) return;
        const value = Number(String(input.value || '').trim());
        if (!Number.isFinite(value) || value < 1) return;
        goToPage(value);
      }

      function goToCategoryPage(page) {
        const target = Number(page);
        if (!Number.isFinite(target)) return;
        currentCategoryPage = Math.max(1, target);
        renderCategories();
      }

      function prevCategoryPage() {
        if (currentCategoryPage > 1) {
          currentCategoryPage -= 1;
          renderCategories();
        }
      }

      function nextCategoryPage() {
        currentCategoryPage += 1;
        renderCategories();
      }

      function jumpCategoryPage() {
        const input = document.getElementById('categories-page-jump');
        if (!input) return;
        const value = Number(String(input.value || '').trim());
        if (!Number.isFinite(value) || value < 1) return;
        goToCategoryPage(value);
      }

      function goToTagPage(page) {
        const target = Number(page);
        if (!Number.isFinite(target)) return;
        currentTagPage = Math.max(1, target);
        renderTags();
      }

      function prevTagPage() {
        if (currentTagPage > 1) {
          currentTagPage -= 1;
          renderTags();
        }
      }

      function nextTagPage() {
        currentTagPage += 1;
        renderTags();
      }

      function jumpTagPage() {
        const input = document.getElementById('tags-page-jump');
        if (!input) return;
        const value = Number(String(input.value || '').trim());
        if (!Number.isFinite(value) || value < 1) return;
        goToTagPage(value);
      }

      function goToNavPage(page) {
        const target = Number(page);
        if (!Number.isFinite(target)) return;
        currentNavPage = Math.max(1, target);
        renderNav();
      }

      function prevNavPage() {
        if (currentNavPage > 1) {
          currentNavPage -= 1;
          renderNav();
        }
      }

      function nextNavPage() {
        currentNavPage += 1;
        renderNav();
      }

      function jumpNavPage() {
        const input = document.getElementById('nav-page-jump');
        if (!input) return;
        const value = Number(String(input.value || '').trim());
        if (!Number.isFinite(value) || value < 1) return;
        goToNavPage(value);
      }

      function paginateList(list, current) {
        const total = list.length;
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        let safeCurrent = current;
        if (safeCurrent > totalPages) safeCurrent = totalPages;
        if (safeCurrent < 1) safeCurrent = 1;
        const start = (safeCurrent - 1) * pageSize;
        const pageItems = list.slice(start, start + pageSize);
        return { pageItems, total, totalPages, current: safeCurrent };
      }

      function getFilteredCategories() {
        const query = categorySearchQuery.trim().toLowerCase();
        if (!query) return categories.slice();
        return categories.filter((c) => {
          const name = String(c.name || '').toLowerCase();
          const slug = String(c.slug || '').toLowerCase();
          return name.includes(query) || slug.includes(query);
        });
      }

      function getFilteredTags() {
        const query = tagSearchQuery.trim().toLowerCase();
        if (!query) return tags.slice();
        return tags.filter((t) => {
          const name = String(t.name || '').toLowerCase();
          const slug = String(t.slug || '').toLowerCase();
          const parent = String(t.parent || '').toLowerCase();
          return name.includes(query) || slug.includes(query) || parent.includes(query);
        });
      }

      function renderCategories() {
        const filtered = getFilteredCategories();
        const { pageItems, total, totalPages, current } = paginateList(filtered, currentCategoryPage);
        currentCategoryPage = current;
        const body = document.getElementById('categories-body');
        
        // 按栏目分组
        const groupedCategories = {};
        pageItems.forEach((c) => {
          const parent = c.parent || '未分类';
          if (!groupedCategories[parent]) {
            groupedCategories[parent] = [];
          }
          groupedCategories[parent].push(c);
        });
        
        // 生成分组后的HTML
        let html = '';
        Object.entries(groupedCategories).forEach(([column, cats]) => {
          // 添加栏目标题行
          html += `
            <tr class="bg-gray-900/50">
              <td class="px-6 py-3 text-gray-400 font-semibold uppercase text-xs">${column}</td>
              <td class="px-6 py-3"></td>
              <td class="px-6 py-3"></td>
            </tr>
          `;
          
          // 添加该栏目下的分类
          cats.forEach((c) => {
            html += `
              <tr class="hover:bg-gray-800/30 transition-colors">
                <td class="px-6 py-4 text-gray-200 font-medium pl-10">
                  <span class="inline-block w-2.5 h-2.5 rounded-full mr-2 align-middle" style="background:${c.color || '#6366f1'}"></span>
                  ${c.name}
                </td>
                <td class="px-6 py-4 text-gray-500">${c.slug}</td>
                <td class="px-6 py-4 text-right space-x-3">
                  <button class="text-gray-400 hover:text-indigo-400" onclick="openCategoryEditor('${c.id}')"><span class="iconify" data-icon="lucide:edit-3"></span></button>
                  <button class="text-gray-400 hover:text-red-400" onclick="deleteCategory('${c.id}')"><span class="iconify" data-icon="lucide:trash-2"></span></button>
                </td>
              </tr>
            `;
          });
        });
        
        body.innerHTML = html;

        const info = document.getElementById('categories-page-info');
        if (info) {
          info.textContent = total === 0 ? '暂无数据' : `第 ${currentCategoryPage} / ${totalPages} 页，共 ${total} 条`;
        }
        const prevBtn = document.getElementById('categories-prev');
        const nextBtn = document.getElementById('categories-next');
        if (prevBtn) prevBtn.disabled = currentCategoryPage <= 1;
        if (nextBtn) nextBtn.disabled = currentCategoryPage >= totalPages;
        renderPageButtons('categories-page-buttons', currentCategoryPage, totalPages, goToCategoryPage);
      }

      function renderTags() {
        const filtered = getFilteredTags();
        const { pageItems, total, totalPages, current } = paginateList(filtered, currentTagPage);
        currentTagPage = current;
        const body = document.getElementById('tags-body');

        const groupedTags = {};
        pageItems.forEach((t) => {
          const parent = t.parent || '未分类';
          if (!groupedTags[parent]) {
            groupedTags[parent] = [];
          }
          groupedTags[parent].push(t);
        });

        let html = '';
        Object.entries(groupedTags).forEach(([column, list]) => {
          html += `
            <tr class="bg-gray-900/50">
              <td class="px-6 py-3 text-gray-400 font-semibold uppercase text-xs">${column}</td>
              <td class="px-6 py-3"></td>
              <td class="px-6 py-3"></td>
              <td class="px-6 py-3"></td>
            </tr>
          `;

          list.forEach((t) => {
            html += `
              <tr class="hover:bg-gray-800/30 transition-colors">
                <td class="px-6 py-4 text-gray-200 font-medium pl-10">${t.name}</td>
                <td class="px-6 py-4 text-gray-500">${t.slug}</td>
                <td class="px-6 py-4 text-gray-500">${t.parent || '-'}</td>
                <td class="px-6 py-4 text-right space-x-3">
                  <button class="text-gray-400 hover:text-indigo-400" onclick="openTagEditor('${t.id}')"><span class="iconify" data-icon="lucide:edit-3"></span></button>
                  <button class="text-gray-400 hover:text-red-400" onclick="deleteTag('${t.id}')"><span class="iconify" data-icon="lucide:trash-2"></span></button>
                </td>
              </tr>
            `;
          });
        });

        body.innerHTML = html;

        const info = document.getElementById('tags-page-info');
        if (info) {
          info.textContent = total === 0 ? '暂无数据' : `第 ${currentTagPage} / ${totalPages} 页，共 ${total} 条`;
        }
        const prevBtn = document.getElementById('tags-prev');
        const nextBtn = document.getElementById('tags-next');
        if (prevBtn) prevBtn.disabled = currentTagPage <= 1;
        if (nextBtn) nextBtn.disabled = currentTagPage >= totalPages;
        renderPageButtons('tags-page-buttons', currentTagPage, totalPages, goToTagPage);
      }

      function renderNav() {
        const sortedNav = navItems
          .slice()
          .sort((a, b) => (Number(a.order || 0) || 0) - (Number(b.order || 0) || 0));
        const { pageItems, total, totalPages, current } = paginateList(sortedNav, currentNavPage);
        currentNavPage = current;
        const body = document.getElementById('nav-body');
        body.innerHTML = pageItems.map((n) => `
          <tr class="hover:bg-gray-800/30 transition-colors nav-row" data-id="${n.id}">
            <td class="px-6 py-4 text-gray-200 font-medium">${n.label}</td>
            <td class="px-6 py-4 text-gray-500">${n.href}</td>
            <td class="px-6 py-4 text-gray-500">${n.order}</td>
            <td class="px-6 py-4 text-gray-500">${n.visible ? '是' : '否'}</td>
            <td class="px-6 py-4 text-right space-x-3">
              <button class="text-gray-400 hover:text-indigo-400" onclick="openNavEditor('${n.id}')"><span class="iconify" data-icon="lucide:edit-3"></span></button>
              <button class="text-gray-400 hover:text-red-400" onclick="deleteNav('${n.id}')"><span class="iconify" data-icon="lucide:trash-2"></span></button>
            </td>
          </tr>
        `).join('');

        const info = document.getElementById('nav-page-info');
        if (info) {
          info.textContent = total === 0 ? '暂无数据' : `第 ${currentNavPage} / ${totalPages} 页，共 ${total} 条`;
        }
        const prevBtn = document.getElementById('nav-prev');
        const nextBtn = document.getElementById('nav-next');
        if (prevBtn) prevBtn.disabled = currentNavPage <= 1;
        if (nextBtn) nextBtn.disabled = currentNavPage >= totalPages;
        renderPageButtons('nav-page-buttons', currentNavPage, totalPages, goToNavPage);
        setupNavDrag();
      }

      let draggingNavId = null;

      function setupNavDrag() {
        const body = document.getElementById('nav-body');
        if (!body) return;
        const rows = Array.from(body.querySelectorAll('tr.nav-row'));
        rows.forEach((row) => {
          row.setAttribute('draggable', 'true');
          row.addEventListener('dragstart', (event) => {
            draggingNavId = row.getAttribute('data-id');
            row.classList.add('nav-row-dragging');
            if (event.dataTransfer) {
              event.dataTransfer.effectAllowed = 'move';
              event.dataTransfer.setData('text/plain', draggingNavId || '');
            }
          });
          row.addEventListener('dragover', (event) => {
            event.preventDefault();
            if (row.getAttribute('data-id') === draggingNavId) return;
            row.classList.add('nav-row-over');
          });
          row.addEventListener('dragleave', () => {
            row.classList.remove('nav-row-over');
          });
          row.addEventListener('drop', async (event) => {
            event.preventDefault();
            const dropId = row.getAttribute('data-id');
            const dragId = draggingNavId || (event.dataTransfer ? event.dataTransfer.getData('text/plain') : '');
            rows.forEach((r) => r.classList.remove('nav-row-over', 'nav-row-dragging'));
            if (!dragId || !dropId || dragId === dropId) return;
            await reorderNavByDrag(dragId, dropId);
          });
          row.addEventListener('dragend', () => {
            rows.forEach((r) => r.classList.remove('nav-row-over', 'nav-row-dragging'));
            draggingNavId = null;
          });
        });
      }

      async function reorderNavByDrag(dragId, dropId) {
        const sorted = navItems
          .slice()
          .sort((a, b) => (Number(a.order || 0) || 0) - (Number(b.order || 0) || 0));
        const fromIndex = sorted.findIndex((n) => n.id === dragId);
        const toIndex = sorted.findIndex((n) => n.id === dropId);
        if (fromIndex < 0 || toIndex < 0) return;
        const [moved] = sorted.splice(fromIndex, 1);
        sorted.splice(toIndex, 0, moved);
        sorted.forEach((item, idx) => {
          item.order = idx + 1;
        });
        navItems = sorted;
        renderNav();
        try {
          await Promise.all(sorted.map((item) =>
            api(`/api/nav/${item.id}`, { method: 'PUT', body: JSON.stringify({ order: item.order }) })
          ));
          showToast('已更新导航顺序', false);
        } catch (err) {
          showToast('更新导航顺序失败', true);
        }
      }

      function openEditor(title, bodyHtml, onSave, options = {}) {
        document.getElementById('editor-title').textContent = title;
        document.getElementById('editor-body').innerHTML = bodyHtml;
        const saveBtn = document.getElementById('editor-save');
        const publishBtn = document.getElementById('editor-publish');
        saveBtn.onclick = onSave;
        saveBtn.textContent = options.saveLabel || '保存';
        if (options.onPublish) {
          publishBtn.textContent = options.publishLabel || '发布';
          publishBtn.onclick = options.onPublish;
          publishBtn.classList.remove('hidden');
        } else {
          publishBtn.classList.add('hidden');
          publishBtn.onclick = null;
        }
        document.getElementById('editor').classList.remove('hidden');
        document.getElementById('editor').classList.add('flex');
      }

      function closeEditor() {
        document.getElementById('editor').classList.add('hidden');
        document.getElementById('editor').classList.remove('flex');
        if (mdEditorApp) {
          mdEditorApp.unmount();
          mdEditorApp = null;
        }
        mdEditorRoot = null;
        mdEditorContent = '';
        if (mdEditorAutosaveTimer) {
          clearInterval(mdEditorAutosaveTimer);
          mdEditorAutosaveTimer = null;
        }
        exitEditorFullscreen();
      }

      function parseCsv(value) {
        return String(value || '')
          .split(',')
          .map((s) => s.trim())
          .filter(Boolean);
      }

      async function ensureCategoryByLabel(label) {
        const name = String(label || '').trim();
        if (!name) return null;
        let existing = categories.find((c) => String(c.name || '').trim() === name);
        if (existing) return existing;
        const slug = simpleSlugify(name) || name;
        const created = await api('/api/categories', {
          method: 'POST',
          body: JSON.stringify({ name, slug }),
        });
        categories.push(created);
        categoryNameMap[created.id] = created.name;
        renderCategories();
        return created;
      }

      function collectUsageCounts(kind) {
        const counts = {};
        posts.forEach((post) => {
          const list = Array.isArray(post?.[kind]) ? post[kind] : [];
          list.forEach((id) => {
            counts[id] = (counts[id] || 0) + 1;
          });
        });
        return counts;
      }

      function updateChips(containerId, items, inputId, kind, onChange) {
        const container = document.getElementById(containerId);
        const input = document.getElementById(inputId);
        if (!container || !input) return;
        const selected = new Set(parseCsv(input.value));
        const counts = collectUsageCounts(kind);
        const visibleItems = items
          .slice()
          .sort((a, b) => {
            const ac = counts[a.id] || 0;
            const bc = counts[b.id] || 0;
            if (bc !== ac) return bc - ac;
            return String(a.name || '').localeCompare(String(b.name || ''));
          })
          .slice(0, 5);
        container.innerHTML = visibleItems.map((item) => {
          const active = selected.has(item.id);
          return `
            <button
              class="chip ${active ? 'chip-active' : ''}"
              data-id="${item.id}"
              type="button"
            >
              ${item.name}
            </button>
          `;
        }).join('');

        container.querySelectorAll('button.chip').forEach((btn) => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-id');
            const next = new Set();
            // 对于分类，只允许选择一个
            if (kind === 'categories') {
              next.add(id);
            } else {
              // 对于标签，保持多选
              const current = new Set(parseCsv(input.value));
              if (current.has(id)) current.delete(id);
              else current.add(id);
              current.forEach(itemId => next.add(itemId));
            }
            input.value = Array.from(next).join(', ');
            if (typeof onChange === 'function') onChange();
            updateChips(containerId, items, inputId, kind, onChange);
          });
        });
      }

      function postForm(post) {
        const catValues = (post?.categories || []).map(id => categoryNameMap[id] || id).join(', ');
        const tagValues = (post?.tags || []).map(id => tagNameMap[id] || id).join(', ');
        const createdValue = post?.created_at || todayISO();
        const pinnedChecked = post?.pinned ? 'checked' : '';
        const slugValue = post?.slug || '';
        const columnLabels = getColumnLabels();
        // 确定文章的栏目
        let postColumn = '';
        if (post && post.categories && post.categories.length > 0) {
          const firstCategory = categories.find(c => c.id === post.categories[0]);
          if (firstCategory && firstCategory.parent) {
            postColumn = firstCategory.parent;
          }
        }
        const categoryOptions = columnLabels.map((label) => {
          const selected = label === postColumn ? 'selected' : '';
          return `
            <option value="${label}" ${selected}>${label}</option>
          `;
        }).join('');
        return `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="space-y-4">
              <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">标题</label>
                <input id="post-title" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" value="${post?.title || ''}" />
              </div>
              <div>
                <label class="text-xs font-semibold text-gray-500 uppercase mb-2 block">Slug</label>
                <input id="post-slug" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5 text-gray-300" value="${slugValue}" readonly />
                <p class="text-xs text-gray-500 mt-2">按分类自动生成：分类Slug?id=数字（例如：Vue?id=5）</p>
                <p id="post-slug-status" class="text-xs text-gray-500 mt-2"></p>
                <p id="post-slug-lock-note" class="text-xs text-amber-400 mt-2 hidden">已发布文章默认锁定 slug，避免旧链接失效</p>
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">摘要</label>
                <textarea id="post-summary" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5">${post?.summary || ''}</textarea>
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">封面 URL</label>
                <input id="post-cover" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" value="${post?.cover || ''}" />
              </div>
            </div>
            <div class="space-y-4">
              <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">栏目</label>
                <select id="post-column" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5">
                  <option value="">请选择栏目</option>
                  ${categoryOptions}
                </select>
                <p class="text-xs text-gray-500 mt-2">栏目来自导航名称，选择后会自动写入分类</p>
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">分类（点击卡片选择 / 取消）</label>
                <input id="post-categories" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" value="${catValues}" placeholder="cat-tech, cat-life" />
                <div class="mt-3 flex flex-wrap gap-2" id="cat-chips"></div>
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">标签（点击卡片选择 / 取消）</label>
                <input id="post-tags" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" value="${tagValues}" placeholder="tag-vue, tag-journal" />
                <div class="mt-3 flex flex-wrap gap-2" id="tag-chips"></div>
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">发布时间</label>
                <input id="post-created-at" type="date" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" value="${createdValue}" />
              </div>
              <div class="flex items-center space-x-2">
                <input id="post-pinned" type="checkbox" class="w-4 h-4 rounded bg-gray-900 border-gray-800 text-indigo-600" ${pinnedChecked} />
                <label class="text-sm text-gray-400">置顶</label>
              </div>
            </div>
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">正文（Markdown）</label>
            <div id="md-editor" class="w-full bg-gray-900 border border-gray-800 rounded-lg"></div>
            <textarea id="post-content" class="hidden">${post?.content || ''}</textarea>
            <p class="text-xs text-gray-500 mt-2">自动保存：每 30 秒一次（本地草稿，不会写入 JSON）</p>
          </div>
        `;
      }

      function findEditorFullscreenButton() {
        const root = mdEditorRoot || document.getElementById('md-editor');
        if (!root) return null;
        return root.querySelector('[title="浏览器全屏"], [title="退出浏览器全屏"]');
      }

      function isEditorFullscreen() {
        return !!document.querySelector('.md-editor-fullscreen, .md-editor-page-fullscreen');
      }

      function enterEditorFullscreen() {
        if (isEditorFullscreen()) {
          mdEditorFullscreenEnabled = true;
          return;
        }
        const btn = findEditorFullscreenButton();
        if (btn) {
          btn.click();
          setTimeout(() => {
            mdEditorFullscreenEnabled = isEditorFullscreen();
          }, 0);
        }
      }

      function exitEditorFullscreen() {
        if (!isEditorFullscreen()) {
          mdEditorFullscreenEnabled = false;
          return;
        }
        const btn = findEditorFullscreenButton();
        if (btn) {
          btn.click();
          setTimeout(() => {
            mdEditorFullscreenEnabled = isEditorFullscreen();
          }, 0);
        }
      }

      function startAutosaveDraft(id) {
        if (mdEditorAutosaveTimer) clearInterval(mdEditorAutosaveTimer);
        mdEditorAutosaveTimer = setInterval(() => {
          const key = id ? `draft:${id}` : 'draft:new';
          try {
            localStorage.setItem(key, mdEditorContent || '');
            showToast('已自动保存草稿', false);
          } catch (err) {
            // ignore storage errors
          }
        }, 30000);
      }

      function getDraftContent(id) {
        const key = id ? `draft:${id}` : 'draft:new';
        try {
          return localStorage.getItem(key) || '';
        } catch (err) {
          return '';
        }
      }

      function clearDraftContent(id) {
        const key = id ? `draft:${id}` : 'draft:new';
        try {
          localStorage.removeItem(key);
        } catch (err) {
          // ignore
        }
      }

      function mountMdEditor(content, id) {
        mdEditorContent = content || '';
        const root = document.getElementById('md-editor');
        if (!root || !window.Vue || !window.MdEditorV3) {
          const fallback = document.getElementById('post-content');
          if (fallback) {
            fallback.classList.remove('hidden');
            fallback.value = mdEditorContent;
          }
          return;
        }
        if (mdEditorApp) {
          mdEditorApp.unmount();
          mdEditorApp = null;
        }
        mdEditorRoot = root;
        const { createApp, ref, watch } = Vue;
        const MdEditor = MdEditorV3.MdEditor || MdEditorV3;
        if (!MdEditor) {
          const fallback = document.getElementById('post-content');
          if (fallback) {
            fallback.classList.remove('hidden');
            fallback.value = mdEditorContent;
          }
          showToast('编辑器加载失败，已启用简易输入框', true);
          return;
        }
        mdEditorApp = createApp({
          setup() {
            const text = ref(mdEditorContent);
            const handleSave = () => {
              exitEditorFullscreen();
            };
            watch(text, (val) => {
              mdEditorContent = val;
            });
            return { text, handleSave };
          },
          template: '<MdEditor v-model="text" theme="dark" :previewTheme="previewTheme" style="height: 320px;" @onSave="handleSave" />',
          data() {
            return { previewTheme: settings.markdownTheme || 'default' };
          },
        });
        mdEditorApp.component('MdEditor', MdEditor);
        mdEditorApp.mount(root);

        root.onclick = (event) => {
          if (event && event.target && event.target.closest) {
            const toolbar = event.target.closest('.md-editor-toolbar');
            if (toolbar) return;
          }
          enterEditorFullscreen();
        };
        startAutosaveDraft(id);
      }

      function openPostEditor(id) {
        const post = posts.find((p) => p.id === id);
        const handleSubmit = async (nextStatus) => {
          const fallbackContent = document.getElementById('post-content')?.value || '';
          const columnLabel = String(columnSelect?.value || '').trim();
          const categoryIds = parseCsv(document.getElementById('post-categories').value);
          
          const payload = {
            title: document.getElementById('post-title').value.trim(),
            slug: document.getElementById('post-slug').value.trim(),
            summary: document.getElementById('post-summary').value.trim(),
            cover: document.getElementById('post-cover').value.trim(),
            categories: categoryIds,
            tags: parseCsv(document.getElementById('post-tags').value),
            status: nextStatus === 'published' ? 'published' : 'draft',
            created_at: document.getElementById('post-created-at').value,
            pinned: document.getElementById('post-pinned').checked,
            content: mdEditorContent || fallbackContent,
          };
          if (!payload.title || !payload.summary || !payload.content) {
            return setStatus('标题、摘要、正文为必填', true);
          }
          if (!columnLabel) {
            return setStatus('请选择栏目', true);
          }
          if (!categoryIds.length) {
            return setStatus('请选择分类', true);
          }
          if (!payload.slug) {
            return setStatus('请先选择栏目和分类生成 slug', true);
          }
          const pinnedCount = posts.filter((p) => p.pinned).length;
          const willPinNew = payload.pinned && (!post || !post.pinned);
          if (willPinNew && pinnedCount >= 3) {
            if (!autoUnpinOnLimit) {
              return setStatus('置顶最多只能有 3 篇', true);
            }
            const pinnedPosts = posts
              .filter((p) => p.pinned && (!post || p.id !== post.id))
              .sort((a, b) => {
                const ad = a.updated_at || a.created_at || '';
                const bd = b.updated_at || b.created_at || '';
                return ad.localeCompare(bd);
              });
            const toUnpin = pinnedPosts[0];
            if (toUnpin) {
              await api(`/api/posts/${toUnpin.id}`, { method: 'PUT', body: JSON.stringify({ pinned: false }) });
            }
          }
          if (post) {
            await api(`/api/posts/${post.id}`, {
              method: 'PUT',
              body: JSON.stringify({ ...payload, auto_unpin: autoUnpinOnLimit }),
            });
          } else {
            await api('/api/posts', {
              method: 'POST',
              body: JSON.stringify({ ...payload, auto_unpin: autoUnpinOnLimit }),
            });
          }
          await loadAll();
          clearDraftContent(post?.id || null);
          exitEditorFullscreen();
          closeEditor();
        };
        openEditor(
          post ? '编辑文章' : '新增文章',
          postForm(post),
          () => handleSubmit('draft'),
          {
            saveLabel: '保存草稿',
            onPublish: () => handleSubmit('published'),
            publishLabel: '发布',
          },
        );

        const categoryInput = document.getElementById('post-categories');
        const tagInput = document.getElementById('post-tags');
        const slugInput = document.getElementById('post-slug');
        const slugStatus = document.getElementById('post-slug-status');
        const slugLockNote = document.getElementById('post-slug-lock-note');
        const columnSelect = document.getElementById('post-column');
        const currentPostId = post?.id || null;
        const isPublished = post?.status === 'published';

        const syncColumnFromCategories = () => {
          // 不再根据分类来同步栏目，保持当前选择的栏目不变
          // 这样选择分类时栏目不会消失
        };

        const filterTagsByColumn = (label) => {
          if (!label) return [];
          const filteredTags = tags.filter((t) => t.parent === label);
          return filteredTags.length ? filteredTags : [];
        };

        const syncCategoriesFromColumn = () => {
          if (!columnSelect || !categoryInput) return;
          const label = String(columnSelect.value || '').trim();
          if (!label) {
            categoryInput.value = '';
            updateChips('cat-chips', [], 'post-categories', 'categories', handleCategoryChange);
            updateChips('tag-chips', [], 'post-tags', 'tags');
            return;
          }
          // 过滤出与当前栏目相关的分类
          const filteredCategories = categories.filter(c => c.parent === label);
          // 按使用频率排序，显示前5个
          const counts = collectUsageCounts('categories');
          const sortedCategories = filteredCategories
            .slice()
            .sort((a, b) => {
              const ac = counts[a.id] || 0;
              const bc = counts[b.id] || 0;
              if (bc !== ac) return bc - ac;
              return String(a.name || '').localeCompare(String(b.name || ''));
            })
            .slice(0, 5);
          categoryInput.value = '';
          // 更新分类选择卡片，只显示与当前栏目相关的分类
          updateChips('cat-chips', sortedCategories, 'post-categories', 'categories', handleCategoryChange);
          updateChips('tag-chips', filterTagsByColumn(label), 'post-tags', 'tags');
        };

        const applySlugLock = () => {
          if (!slugInput) return;
          slugInput.readOnly = true;
          slugInput.classList.toggle('opacity-60', isPublished);
          if (slugLockNote) slugLockNote.classList.toggle('hidden', !isPublished);
        };

        const applyColumnSlug = () => {
          if (!slugInput || isPublished) return;
          const columnLabel = String(columnSelect?.value || '').trim();
          const categoryIds = parseCsv(categoryInput?.value || '');
          const firstCategoryId = categoryIds[0] || '';
          const category = firstCategoryId ? categories.find(c => c.id === firstCategoryId) : null;
          const categorySlug = category ? (category.slug || simpleSlugify(category.name)) : '';
          
          if (!columnLabel) {
            slugInput.value = '';
            if (slugStatus) {
              slugStatus.textContent = '请选择栏目以生成 slug';
              slugStatus.className = 'text-xs text-amber-400 mt-2';
            }
            return;
          }
          
          if (!categorySlug) {
            slugInput.value = '';
            if (slugStatus) {
              slugStatus.textContent = '请选择分类以生成 slug';
              slugStatus.className = 'text-xs text-amber-400 mt-2';
            }
            return;
          }
          
          const columnSlug = simpleSlugify(columnLabel);
          const index = columnCategoryPostIndex(columnLabel, firstCategoryId, currentPostId);
          const next = `${columnSlug}/${categorySlug}?id=${index}`;
          
          if (!next) {
            slugInput.value = '';
            if (slugStatus) {
              slugStatus.textContent = '生成 slug 失败';
              slugStatus.className = 'text-xs text-amber-400 mt-2';
            }
            return;
          }
          
          slugInput.value = next;
          if (slugStatus) {
            slugStatus.textContent = `Slug 已生成：${next}`;
            slugStatus.className = 'text-xs text-emerald-400 mt-2';
          }
        };

        function columnCategoryPostIndex(columnLabel, categoryId, currentId) {
          if (!columnLabel || !categoryId) return 1;
          const list = posts
            .filter((p) => {
              // 查找与栏目标签匹配的分类
              const catIds = Array.isArray(p.categories) ? p.categories : [];
              return catIds.includes(categoryId);
            })
            .slice()
            .sort((a, b) => {
              const ad = a.created_at || '';
              const bd = b.created_at || '';
              return ad.localeCompare(bd);
            });
          if (currentId) {
            const existingIndex = list.findIndex((p) => p.id === currentId);
            if (existingIndex >= 0) return existingIndex + 1;
          }
          return list.length + 1;
        }

        const handleCategoryChange = () => {
          syncColumnFromCategories();
          applyColumnSlug();
        };

        const handleColumnChange = () => {
          applyColumnSlug();
        };

        // 初始化时根据栏目显示分类卡片
        if (columnSelect) {
          const label = String(columnSelect.value || '').trim();
          if (label) {
            // 过滤出与当前栏目相关的分类
            const filteredCategories = categories.filter(c => c.parent === label);
            // 按使用频率排序，显示前5个
            const counts = collectUsageCounts('categories');
            const sortedCategories = filteredCategories
              .slice()
              .sort((a, b) => {
                const ac = counts[a.id] || 0;
                const bc = counts[b.id] || 0;
                if (bc !== ac) return bc - ac;
                return String(a.name || '').localeCompare(String(b.name || ''));
              })
              .slice(0, 5);
            updateChips('cat-chips', sortedCategories, 'post-categories', 'categories', handleCategoryChange);
            updateChips('tag-chips', filterTagsByColumn(label), 'post-tags', 'tags');
          } else {
            updateChips('cat-chips', [], 'post-categories', 'categories', handleCategoryChange);
            updateChips('tag-chips', [], 'post-tags', 'tags');
          }
        } else {
          updateChips('cat-chips', [], 'post-categories', 'categories', handleCategoryChange);
          updateChips('tag-chips', [], 'post-tags', 'tags');
        }

        syncColumnFromCategories();
        if (columnSelect) {
          columnSelect.addEventListener('change', async () => {
            await syncCategoriesFromColumn();
            handleColumnChange();
          });
        }

        // 初始化时应用栏目slug
        handleColumnChange();

        if (categoryInput) {
          categoryInput.addEventListener('input', () => {
            const label = String(columnSelect?.value || '').trim();
            let chipsCategories = [];
            if (label) {
              // 只显示当前栏目下的分类
              const filteredCategories = categories.filter(c => c.parent === label);
              const counts = collectUsageCounts('categories');
              chipsCategories = filteredCategories
                .slice()
                .sort((a, b) => {
                  const ac = counts[a.id] || 0;
                  const bc = counts[b.id] || 0;
                  if (bc !== ac) return bc - ac;
                  return String(a.name || '').localeCompare(String(b.name || ''));
                })
                .slice(0, 5);
            }
            updateChips('cat-chips', chipsCategories, 'post-categories', 'categories', handleCategoryChange);
            handleCategoryChange();
          });
        }
        if (tagInput) {
          tagInput.addEventListener('input', () => {
            const label = String(columnSelect?.value || '').trim();
            updateChips('tag-chips', filterTagsByColumn(label), 'post-tags', 'tags');
          });
        }

        applyColumnSlug();
        applySlugLock();

        const draft = getDraftContent(post?.id || null);
        const initialContent = draft || post?.content || '';
        mountMdEditor(initialContent, post?.id || null);
      }

      async function deletePost(id) {
        if (!confirm('确定删除文章？')) return;
        await api(`/api/posts/${id}`, { method: 'DELETE' });
        await loadAll();
      }

      function openCategoryEditor(id) {
        const cat = categories.find((c) => c.id === id);
        const columnLabels = getColumnLabels();
        const parentOptions = columnLabels.map((label) => {
          const selected = cat && cat.parent === label ? 'selected' : '';
          return `
            <option value="${label}" ${selected}>${label}</option>
          `;
        }).join('');
        
        openEditor(cat ? '编辑分类' : '新增分类', `
          <div class="space-y-4">
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">名称</label>
              <input id="cat-name" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" value="${cat?.name || ''}" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">所属栏目</label>
              <select id="cat-parent" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5">
                <option value="">请选择栏目</option>
                ${parentOptions}
              </select>
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">Slug</label>
              <input id="cat-slug" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" value="${cat?.slug || ''}" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">颜色</label>
              <div class="flex items-center space-x-3">
                <input id="cat-color" type="color" class="w-10 h-10 rounded bg-gray-900 border border-gray-800" value="${cat?.color || '#6366f1'}" />
                <input id="cat-color-text" class="flex-1 bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" value="${cat?.color || '#6366f1'}" />
              </div>
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">描述</label>
              <textarea id="cat-desc" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5">${cat?.description || ''}</textarea>
            </div>
          </div>
        `, async () => {
          const payload = {
            name: document.getElementById('cat-name').value.trim(),
            slug: document.getElementById('cat-slug').value.trim(),
            description: document.getElementById('cat-desc').value.trim(),
            color: document.getElementById('cat-color-text').value.trim(),
            parent: document.getElementById('cat-parent').value.trim(),
          };
          if (!payload.name) return setStatus('分类名称为必填', true);
          if (!payload.parent) return setStatus('所属栏目为必填', true);
          if (cat) await api(`/api/categories/${cat.id}`, { method: 'PUT', body: JSON.stringify(payload) });
          else await api('/api/categories', { method: 'POST', body: JSON.stringify(payload) });
          await loadAll();
          closeEditor();
        });

        const colorPicker = document.getElementById('cat-color');
        const colorText = document.getElementById('cat-color-text');
        if (colorPicker && colorText) {
          colorPicker.addEventListener('input', (e) => {
            colorText.value = e.target.value;
          });
          colorText.addEventListener('input', (e) => {
            colorPicker.value = e.target.value || '#6366f1';
          });
        }
      }

      async function deleteCategory(id) {
        if (!confirm('确定删除分类？')) return;
        await api(`/api/categories/${id}`, { method: 'DELETE' });
        await loadAll();
      }

        function openTagEditor(id) {
          const tag = tags.find((t) => t.id === id);
          const columnLabels = getColumnLabels();
          const parentOptions = columnLabels.map((label) => {
            const selected = tag && tag.parent === label ? 'selected' : '';
            return `
              <option value="${label}" ${selected}>${label}</option>
            `;
          }).join('');
          openEditor(tag ? '编辑标签' : '新增标签', `
            <div class="space-y-4">
              <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">名称</label>
                <input id="tag-name" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" value="${tag?.name || ''}" />
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">所属栏目</label>
                <select id="tag-parent" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5">
                  <option value="">请选择栏目</option>
                  ${parentOptions}
                </select>
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">Slug</label>
                <input id="tag-slug" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" value="${tag?.slug || ''}" />
              </div>
            </div>
          `, async () => {
            const payload = {
              name: document.getElementById('tag-name').value.trim(),
              slug: document.getElementById('tag-slug').value.trim(),
              parent: document.getElementById('tag-parent').value.trim(),
            };
            if (!payload.name) return setStatus('标签名称为必填', true);
            if (!payload.parent) return setStatus('所属栏目为必填', true);
            if (tag) await api(`/api/tags/${tag.id}`, { method: 'PUT', body: JSON.stringify(payload) });
            else await api('/api/tags', { method: 'POST', body: JSON.stringify(payload) });
            await loadAll();
            closeEditor();
          });
        }

      async function deleteTag(id) {
        if (!confirm('确定删除标签？')) return;
        await api(`/api/tags/${id}`, { method: 'DELETE' });
        await loadAll();
      }

      function openNavEditor(id) {
        const item = navItems.find((n) => n.id === id);
        openEditor(item ? '编辑导航' : '新增导航', `
          <div class="space-y-4">
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">名称</label>
              <input id="nav-label" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" value="${item?.label || ''}" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">链接</label>
              <input id="nav-href" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" value="${item?.href || ''}" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">封面图 URL</label>
              <input id="nav-cover" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" value="${item?.cover || ''}" placeholder="https://..." />
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">顺序</label>
              <input id="nav-order" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" value="${item?.order || ''}" />
            </div>
            <div class="flex items-center space-x-2">
              <input id="nav-visible" type="checkbox" class="w-4 h-4 rounded bg-gray-900 border-gray-800 text-indigo-600" ${item?.visible !== false ? 'checked' : ''} />
              <label class="text-sm text-gray-400">显示</label>
            </div>
          </div>
        `, async () => {
          const payload = {
            label: document.getElementById('nav-label').value.trim(),
            href: document.getElementById('nav-href').value.trim(),
            cover: document.getElementById('nav-cover').value.trim(),
            order: Number(document.getElementById('nav-order').value || 0),
            visible: document.getElementById('nav-visible').checked,
          };
          if (!payload.label || !payload.href) return setStatus('导航名称和链接为必填', true);
          if (item) await api(`/api/nav/${item.id}`, { method: 'PUT', body: JSON.stringify(payload) });
          else await api('/api/nav', { method: 'POST', body: JSON.stringify(payload) });
          await loadAll();
          closeEditor();
        });
      }

      async function deleteNav(id) {
        if (!confirm('确定删除导航？')) return;
        await api(`/api/nav/${id}`, { method: 'DELETE' });
        await loadAll();
      }

      async function generateJson() {
        await api('/api/generate', { method: 'POST' });
        showToast('已生成 JSON 文件', false);
      }

      function applySettingsToUI() {
        const theme = settings.markdownTheme || 'default';
        document.querySelectorAll('input[name=\"md-theme\"]').forEach((input) => {
          input.checked = input.value === theme;
        });
      }

      function applyProfileSettingsToUI() {
        const defaultProfile = {
          name: 'Lemon',
          subtitle: '记录灵感 · 设计 · 代码',
          motto: '以持续输出为信仰，把每一次学习都变成可复用的经验。',
          avatar: '',
          github: '',
          planet: '',
          email: '',
        };
        const defaultAbout = {
          title: '关于这个博客',
          content: '这里记录我的学习、实验与思考。内容聚焦于现代 Web 开发、效率工具和工程实践。',
          skillsTitle: '核心技能栈',
        };
        const profile = { ...defaultProfile, ...(settings.profile || {}) };
        const about = { ...defaultAbout, ...(settings.about || {}) };
        const skills = Array.isArray(about.skills) ? about.skills : [
          { label: 'TypeScript', icon: 'logos:typescript-icon', color: '#34d399' },
          { label: 'Rust', icon: 'logos:rust', color: '#f97316' },
          { label: 'React', icon: 'logos:react', color: '#60a5fa' },
          { label: 'Cloud Native', icon: 'logos:ebpf', color: '#a855f7' },
        ];
        const setValue = (id, value) => {
          const el = document.getElementById(id);
          if (el) el.value = value || '';
        };
        setValue('profile-name', profile.name);
        setValue('profile-subtitle', profile.subtitle);
        setValue('profile-motto', profile.motto);
        setValue('profile-avatar', profile.avatar);
        setValue('profile-github', profile.github);
        setValue('profile-planet', profile.planet);
        setValue('profile-email', profile.email);
        setValue('about-title', about.title);
        setValue('about-content', about.content);
        setValue('skills-title', about.skillsTitle);
        setValue('skills-json', JSON.stringify(skills, null, 2));
      }

      async function saveSettings() {
        const selected = document.querySelector('input[name=\"md-theme\"]:checked');
        const markdownTheme = selected ? selected.value : 'default';
        const payload = { markdownTheme };
        settings = await api('/api/settings', { method: 'PUT', body: JSON.stringify(payload) });
        applySettingsToUI();
        showToast('设置已保存', false);
      }

      async function saveProfileSettings() {
        try {
          const skillsInput = document.getElementById('skills-json');
          let skills = [];
          if (skillsInput && skillsInput.value.trim()) {
            skills = JSON.parse(skillsInput.value);
            if (!Array.isArray(skills)) throw new Error('技能列表必须为 JSON 数组');
          }
          const payload = {
            markdownTheme: settings.markdownTheme || 'default',
            profile: {
              name: document.getElementById('profile-name')?.value?.trim() || '',
              subtitle: document.getElementById('profile-subtitle')?.value?.trim() || '',
              motto: document.getElementById('profile-motto')?.value?.trim() || '',
              avatar: document.getElementById('profile-avatar')?.value?.trim() || '',
              github: document.getElementById('profile-github')?.value?.trim() || '',
              planet: document.getElementById('profile-planet')?.value?.trim() || '',
              email: document.getElementById('profile-email')?.value?.trim() || '',
            },
            about: {
              title: document.getElementById('about-title')?.value?.trim() || '',
              content: document.getElementById('about-content')?.value?.trim() || '',
              skillsTitle: document.getElementById('skills-title')?.value?.trim() || '',
              skills,
            },
          };
          settings = await api('/api/settings', { method: 'PUT', body: JSON.stringify(payload) });
          applyProfileSettingsToUI();
          showToast('个人介绍已保存', false);
        } catch (err) {
          showToast(err.message || '保存失败', true);
        }
      }

      async function publish() {
        const title = document.getElementById('publish-title').value.trim();
        if (!title) return setStatus('请输入提交标题', true);
        await api('/api/publish', { method: 'POST', body: JSON.stringify({ title }) });
        showToast('发布成功并推送', false);
      }

      async function loadAll() {
        try {
          const results = await Promise.all([
            api('/api/posts'),
            api('/api/categories'),
            api('/api/tags'),
            api('/api/nav').catch(() => []),
            api('/api/issues').catch(() => []),
            api('/api/tools').catch(() => []),
            api('/api/settings').catch(() => ({ markdownTheme: 'default' })),
          ]);
          [posts, categories, tags, navItems, issues, tools, settings] = results;
          applySettingsToUI();
          applyProfileSettingsToUI();
          categoryNameMap = Object.fromEntries(categories.map((c) => [c.id, c.name]));
          tagNameMap = Object.fromEntries(tags.map((t) => [t.id, t.name]));
          renderPosts();
          renderCategories();
          renderTags();
          renderNav();
          renderIssues();
          renderTools();
          
        } catch (err) {
          setStatus(err.message || '加载失败', true);
        }
      }

      const searchInput = document.getElementById('post-search');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          searchQuery = e.target.value || '';
          currentPage = 1;
          renderPosts();
        });
      }

      const autoUnpinInput = document.getElementById('auto-unpin');
      if (autoUnpinInput) {
        autoUnpinInput.addEventListener('change', (e) => {
          autoUnpinOnLimit = e.target.checked;
        });
      }

      const categorySearchInput = document.getElementById('category-search');
      if (categorySearchInput) {
        categorySearchInput.addEventListener('input', (e) => {
          categorySearchQuery = e.target.value || '';
          currentCategoryPage = 1;
          renderCategories();
        });
      }

      const tagSearchInput = document.getElementById('tag-search');
      if (tagSearchInput) {
        tagSearchInput.addEventListener('input', (e) => {
          tagSearchQuery = e.target.value || '';
          currentTagPage = 1;
          renderTags();
        });
      }

      const jumpInput = document.getElementById('post-page-jump');
      if (jumpInput) {
        jumpInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') jumpPage();
        });
      }

      const jumpCategoryInput = document.getElementById('categories-page-jump');
      if (jumpCategoryInput) {
        jumpCategoryInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') jumpCategoryPage();
        });
      }

      const jumpTagInput = document.getElementById('tags-page-jump');
      if (jumpTagInput) {
        jumpTagInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') jumpTagPage();
        });
      }

      const jumpNavInput = document.getElementById('nav-page-jump');
      if (jumpNavInput) {
        jumpNavInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') jumpNavPage();
        });
      }

      setTab('posts');
      // 问题管理相关函数
      function issueForm(issue) {
        const titleValue = issue?.title || '';
        const descriptionValue = issue?.description || '';
        const priorityValue = issue?.priority || '普通';
        const statusValue = issue?.status || '待解决';
        const solutionStepsValue = issue?.solution_steps || '';
        const resultSummaryValue = issue?.result_summary || '';
        const createdValue = issue?.created_at || todayISO();
        return `
          <div class="space-y-6">
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">标题</label>
              <input id="issue-title" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" value="${titleValue}" />
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">优先级</label>
                <select id="issue-priority" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5">
                  <option value="紧急" ${priorityValue === '紧急' ? 'selected' : ''}>紧急</option>
                  <option value="普通" ${priorityValue === '普通' ? 'selected' : ''}>普通</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">状态</label>
                <select id="issue-status" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5">
                  <option value="待解决" ${statusValue === '待解决' ? 'selected' : ''}>待解决</option>
                  <option value="解决中" ${statusValue === '解决中' ? 'selected' : ''}>解决中</option>
                  <option value="已解决" ${statusValue === '已解决' ? 'selected' : ''}>已解决</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">问题描述</label>
              <textarea id="issue-description" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" rows="4">${descriptionValue}</textarea>
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">解决步骤</label>
              <textarea id="issue-solution-steps" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" rows="6">${solutionStepsValue}</textarea>
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">Result & Summary</label>
              <textarea id="issue-result-summary" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" rows="4">${resultSummaryValue}</textarea>
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">创建日期</label>
              <input id="issue-created-at" type="date" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" value="${createdValue}" />
            </div>
          </div>
        `;
      }

      function openIssueEditor(id) {
        const issue = issues.find((i) => i.id === id);
        const handleSubmit = async () => {
          const payload = {
            title: document.getElementById('issue-title').value.trim(),
            description: document.getElementById('issue-description').value.trim(),
            priority: document.getElementById('issue-priority').value.trim(),
            status: document.getElementById('issue-status').value.trim(),
            solution_steps: document.getElementById('issue-solution-steps').value.trim(),
            result_summary: document.getElementById('issue-result-summary').value.trim(),
            created_at: document.getElementById('issue-created-at').value,
          };
          if (!payload.title || !payload.description) {
            return setStatus('标题和描述为必填', true);
          }
          if (issue) {
            await api(`/api/issues/${issue.id}`, {
              method: 'PUT',
              body: JSON.stringify(payload),
            });
          } else {
            await api('/api/issues', {
              method: 'POST',
              body: JSON.stringify(payload),
            });
          }
          await loadAll();
          closeEditor();
        };
        openEditor(
          issue ? '编辑问题' : '新增问题',
          issueForm(issue),
          handleSubmit,
          {
            saveLabel: '保存',
          }
        );
      }

      function renderIssues() {
        const filtered = issues.filter((i) => {
          if (!issueSearchQuery) return true;
          const query = issueSearchQuery.toLowerCase();
          return i.title.toLowerCase().includes(query) || i.description.toLowerCase().includes(query);
        }).sort((a, b) => {
          const ad = a.created_at || '';
          const bd = b.created_at || '';
          return bd.localeCompare(ad);
        });
        const total = filtered.length;
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        if (currentIssuePage > totalPages) currentIssuePage = totalPages;
        if (currentIssuePage < 1) currentIssuePage = 1;
        const start = (currentIssuePage - 1) * pageSize;
        const pageItems = filtered.slice(start, start + pageSize);
        const body = document.getElementById('issues-body');
        body.innerHTML = pageItems.map((i) => `
          <tr class="hover:bg-gray-800/30 transition-colors">
            <td class="px-6 py-4 text-gray-200 font-medium">${i.title}</td>
            <td class="px-6 py-4">
              <span class="px-2 py-0.5 rounded-full text-xs ${i.priority === '紧急' ? 'bg-red-500/10 text-red-400 border border-red-500/30' : 'bg-gray-800 text-gray-400 border border-gray-700'}">
                ${i.priority}
              </span>
            </td>
            <td class="px-6 py-4">
              <span class="px-2 py-0.5 rounded-full text-xs ${i.status === '已解决' ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/30' : 'bg-gray-800 text-gray-400 border border-gray-700'}">
                ${i.status}
              </span>
            </td>
            <td class="px-6 py-4 text-gray-500">${i.created_at}</td>
            <td class="px-6 py-4 text-right space-x-3">
              <button class="text-gray-400 hover:text-indigo-400" onclick="openIssueEditor('${i.id}')"><span class="iconify" data-icon="lucide:edit-3"></span></button>
              <button class="text-gray-400 hover:text-red-400" onclick="deleteIssue('${i.id}')"><span class="iconify" data-icon="lucide:trash-2"></span></button>
            </td>
          </tr>
        `).join('');
        const info = document.getElementById('issues-page-info');
        if (info) {
          info.textContent = total === 0 ? '暂无数据' : `第 ${currentIssuePage} / ${totalPages} 页，共 ${total} 条`;
        }
        const prevBtn = document.getElementById('issues-prev');
        const nextBtn = document.getElementById('issues-next');
        if (prevBtn) prevBtn.disabled = currentIssuePage <= 1;
        if (nextBtn) nextBtn.disabled = currentIssuePage >= totalPages;
        renderPageButtons('issues-page-buttons', currentIssuePage, totalPages, goToIssuePage);
      }

      async function deleteIssue(id) {
        if (!confirm('确定删除问题？')) return;
        await api(`/api/issues/${id}`, { method: 'DELETE' });
        await loadAll();
      }

      function goToIssuePage(page) {
        const target = Number(page);
        if (!Number.isFinite(target)) return;
        currentIssuePage = Math.max(1, target);
        renderIssues();
      }

      function prevIssuePage() {
        if (currentIssuePage > 1) {
          currentIssuePage -= 1;
          renderIssues();
        }
      }

      function nextIssuePage() {
        currentIssuePage += 1;
        renderIssues();
      }

      function jumpIssuePage() {
        const input = document.getElementById('issues-page-jump');
        if (!input) return;
        const value = Number(String(input.value || '').trim());
        if (!Number.isFinite(value) || value < 1) return;
        goToIssuePage(value);
      }

      // 工具管理相关函数
      function toolForm(tool) {
        const nameValue = tool?.name || '';
        const descriptionValue = tool?.description || '';
        const typeValue = tool?.type || '在线工具';
        const urlValue = tool?.url || '';
        const sourceValue = tool?.source || '网络';
        const updateDateValue = tool?.update_date || todayISO();
        const createdValue = tool?.created_at || todayISO();
        return `
          <div class="space-y-6">
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">名称</label>
              <input id="tool-name" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" value="${nameValue}" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">描述</label>
              <textarea id="tool-description" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" rows="4">${descriptionValue}</textarea>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">类型</label>
                <select id="tool-type" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5">
                  <option value="在线工具" ${typeValue === '在线工具' ? 'selected' : ''}>在线工具</option>
                  <option value="个人工具" ${typeValue === '个人工具' ? 'selected' : ''}>个人工具</option>
                  <option value="优秀网页" ${typeValue === '优秀网页' ? 'selected' : ''}>优秀网页</option>
                  <option value="插件" ${typeValue === '插件' ? 'selected' : ''}>插件</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">来源</label>
                <select id="tool-source" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5">
                  <option value="网络" ${sourceValue === '网络' ? 'selected' : ''}>网络</option>
                  <option value="自主开发" ${sourceValue === '自主开发' ? 'selected' : ''}>自主开发</option>
                  <option value="推荐" ${sourceValue === '推荐' ? 'selected' : ''}>推荐</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">链接</label>
              <input id="tool-url" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" value="${urlValue}" placeholder="https://" />
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">更新日期</label>
                <input id="tool-update-date" type="date" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" value="${updateDateValue}" />
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase mb-2">创建日期</label>
                <input id="tool-created-at" type="date" class="w-full bg-gray-900 border border-gray-800 rounded-lg px-4 py-2.5" value="${createdValue}" />
              </div>
            </div>
          </div>
        `;
      }

      function openToolEditor(id) {
        const tool = tools.find((t) => t.id === id);
        const handleSubmit = async () => {
          const payload = {
            name: document.getElementById('tool-name').value.trim(),
            description: document.getElementById('tool-description').value.trim(),
            type: document.getElementById('tool-type').value.trim(),
            url: document.getElementById('tool-url').value.trim(),
            source: document.getElementById('tool-source').value.trim(),
            update_date: document.getElementById('tool-update-date').value,
            created_at: document.getElementById('tool-created-at').value,
          };
          if (!payload.name || !payload.description) {
            return setStatus('名称和描述为必填', true);
          }
          if (tool) {
            await api(`/api/tools/${tool.id}`, {
              method: 'PUT',
              body: JSON.stringify(payload),
            });
          } else {
            await api('/api/tools', {
              method: 'POST',
              body: JSON.stringify(payload),
            });
          }
          await loadAll();
          closeEditor();
        };
        openEditor(
          tool ? '编辑工具' : '新增工具',
          toolForm(tool),
          handleSubmit,
          {
            saveLabel: '保存',
          }
        );
      }

      function renderTools() {
        const filtered = tools.filter((t) => {
          if (!toolSearchQuery) return true;
          const query = toolSearchQuery.toLowerCase();
          return t.name.toLowerCase().includes(query) || t.description.toLowerCase().includes(query);
        }).sort((a, b) => {
          const ad = a.update_date || a.created_at || '';
          const bd = b.update_date || b.created_at || '';
          return bd.localeCompare(ad);
        });
        const total = filtered.length;
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        if (currentToolPage > totalPages) currentToolPage = totalPages;
        if (currentToolPage < 1) currentToolPage = 1;
        const start = (currentToolPage - 1) * pageSize;
        const pageItems = filtered.slice(start, start + pageSize);
        const body = document.getElementById('tools-body');
        body.innerHTML = pageItems.map((t) => `
          <tr class="hover:bg-gray-800/30 transition-colors">
            <td class="px-6 py-4 text-gray-200 font-medium">${t.name}</td>
            <td class="px-6 py-4 text-gray-400">${t.type}</td>
            <td class="px-6 py-4 text-gray-500">${t.update_date}</td>
            <td class="px-6 py-4 text-gray-500">${t.source}</td>
            <td class="px-6 py-4 text-right space-x-3">
              <button class="text-gray-400 hover:text-indigo-400" onclick="openToolEditor('${t.id}')"><span class="iconify" data-icon="lucide:edit-3"></span></button>
              <button class="text-gray-400 hover:text-red-400" onclick="deleteTool('${t.id}')"><span class="iconify" data-icon="lucide:trash-2"></span></button>
            </td>
          </tr>
        `).join('');
        const info = document.getElementById('tools-page-info');
        if (info) {
          info.textContent = total === 0 ? '暂无数据' : `第 ${currentToolPage} / ${totalPages} 页，共 ${total} 条`;
        }
        const prevBtn = document.getElementById('tools-prev');
        const nextBtn = document.getElementById('tools-next');
        if (prevBtn) prevBtn.disabled = currentToolPage <= 1;
        if (nextBtn) nextBtn.disabled = currentToolPage >= totalPages;
        renderPageButtons('tools-page-buttons', currentToolPage, totalPages, goToToolPage);
      }

      async function deleteTool(id) {
        if (!confirm('确定删除工具？')) return;
        await api(`/api/tools/${id}`, { method: 'DELETE' });
        await loadAll();
      }

      function goToToolPage(page) {
        const target = Number(page);
        if (!Number.isFinite(target)) return;
        currentToolPage = Math.max(1, target);
        renderTools();
      }

      function prevToolPage() {
        if (currentToolPage > 1) {
          currentToolPage -= 1;
          renderTools();
        }
      }

      function nextToolPage() {
        currentToolPage += 1;
        renderTools();
      }

      function jumpToolPage() {
        const input = document.getElementById('tools-page-jump');
        if (!input) return;
        const value = Number(String(input.value || '').trim());
        if (!Number.isFinite(value) || value < 1) return;
        goToToolPage(value);
      }

      // 绑定搜索事件
      const issueSearchInput = document.getElementById('issue-search');
      if (issueSearchInput) {
        issueSearchInput.addEventListener('input', (e) => {
          issueSearchQuery = e.target.value || '';
          currentIssuePage = 1;
          renderIssues();
        });
      }

      const toolSearchInput = document.getElementById('tool-search');
      if (toolSearchInput) {
        toolSearchInput.addEventListener('input', (e) => {
          toolSearchQuery = e.target.value || '';
          currentToolPage = 1;
          renderTools();
        });
      }

      loadAll();
    </script>
  </body>
</html>
